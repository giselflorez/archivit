{% extends "base.html" %}

{% block extra_styles %}
<style>

    .sort-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        align-items: center;
    }

    .sort-label {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .sort-btn {
        padding: 0.5rem 1.25rem;
        border: 1px solid var(--border-color);
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 400;
        font-family: 'Work Sans', sans-serif;
        transition: all 0.3s ease;
    }

    .sort-btn:hover {
        border-color: var(--accent-dim);
        color: var(--accent-gold);
    }

    .sort-btn.active {
        background: var(--accent-gold);
        color: var(--bg-primary);
        border-color: var(--accent-gold);
    }

    .bulk-actions {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        position: sticky;
        top: 93px;
        z-index: 50;
        transition: all 0.3s ease;
    }

    .bulk-actions.has-selection {
        background: var(--bg-tertiary);
        border-color: var(--accent-gold);
        box-shadow: var(--shadow-subtle);
    }

    .bulk-actions label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 300;
    }

    .bulk-actions input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--accent-gold);
    }

    .action-btn {
        background: transparent;
        color: var(--text-secondary);
        padding: 0.6rem 1.25rem;
        border: 1px solid var(--border-color);
        cursor: pointer;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 400;
        font-family: 'Work Sans', sans-serif;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn:hover:not(:disabled) {
        border-color: var(--accent-gold);
        color: var(--accent-gold);
    }

    .action-btn.danger {
        border-color: var(--accent-warm);
        color: var(--accent-warm);
    }

    .action-btn.danger:hover:not(:disabled) {
        background: var(--accent-warm);
        color: var(--bg-primary);
    }

    .action-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .selection-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        margin-left: auto;
    }

    .selection-count {
        color: var(--accent-gold);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .selection-hint {
        color: var(--text-tertiary);
        font-size: 0.65rem;
        font-weight: 300;
    }

    .keyboard-shortcuts {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        max-width: 350px;
        z-index: 1000;
        box-shadow: var(--shadow-elevated);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .keyboard-shortcuts.visible {
        opacity: 1;
        pointer-events: auto;
    }

    .keyboard-shortcuts h3 {
        font-family: 'Crimson Pro', serif;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--accent-gold);
        margin-bottom: 1rem;
    }

    .shortcut-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .shortcut-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .shortcut-key {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        padding: 0.25rem 0.5rem;
        font-family: 'Courier New', monospace;
        font-size: 0.7rem;
        color: var(--accent-gold);
    }

    .shortcut-desc {
        color: var(--text-secondary);
        font-size: 0.75rem;
        flex: 1;
    }

    .help-toggle {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--accent-gold);
        color: var(--bg-primary);
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-elevated);
        z-index: 999;
    }

    .help-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 24px rgba(212, 165, 116, 0.4);
    }

    .document-grid {
        display: flex;
        flex-direction: column;
        gap: 1px;
        margin-top: 2rem;
        background: var(--border-color);
    }

    .document-card {
        background: var(--bg-secondary);
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        display: flex;
        flex-direction: row;
        position: relative;
        min-height: 100px;
        animation: cardFadeIn 0.5s ease-out backwards;
        padding-left: 3rem;
    }

    @keyframes cardFadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .document-card:nth-child(1) { animation-delay: 0.02s; }
    .document-card:nth-child(2) { animation-delay: 0.04s; }
    .document-card:nth-child(3) { animation-delay: 0.06s; }
    .document-card:nth-child(4) { animation-delay: 0.08s; }
    .document-card:nth-child(5) { animation-delay: 0.1s; }
    .document-card:nth-child(6) { animation-delay: 0.12s; }
    .document-card:nth-child(7) { animation-delay: 0.14s; }
    .document-card:nth-child(8) { animation-delay: 0.16s; }
    .document-card:nth-child(9) { animation-delay: 0.18s; }
    .document-card:nth-child(10) { animation-delay: 0.2s; }

    .document-card:hover {
        background: var(--bg-tertiary);
        box-shadow: inset 4px 0 0 var(--accent-gold);
    }

    .document-card.selected {
        background: var(--bg-tertiary);
        box-shadow: inset 4px 0 0 var(--accent-warm);
    }

    .document-card.focused {
        outline: 2px solid var(--accent-gold);
        outline-offset: -2px;
    }

    .document-card {
        user-select: none;
    }

    .document-inner {
        cursor: pointer;
    }

    .document-card:has(.document-checkbox:checked) .document-inner {
        cursor: default;
    }

    .document-checkbox {
        position: absolute;
        top: 50%;
        left: 0.9rem;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        cursor: pointer;
        z-index: 10;
        accent-color: var(--accent-gold);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .document-card:hover .document-checkbox,
    .document-checkbox:checked {
        opacity: 1;
    }

    .document-image {
        width: 120px;
        height: 100%;
        min-height: 100px;
        object-fit: cover;
        background: var(--bg-tertiary);
        flex-shrink: 0;
        border-right: 1px solid var(--border-color);
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .document-image:hover {
        filter: brightness(0.7);
        border-right: 2px solid var(--accent-gold);
    }

    .document-image::after {
        content: 'Click for Links';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(212, 165, 116, 0.95);
        color: var(--bg-primary);
        padding: 0.5rem;
        font-size: 0.65rem;
        font-weight: 600;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 5;
    }

    .document-image:hover::after {
        opacity: 1;
    }

    .document-image::before {
        content: 'üîó';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 4;
        filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.9));
    }

    .document-image:hover::before {
        opacity: 1;
    }

    div.document-image:hover {
        filter: brightness(1.2);
        border-right: 2px solid var(--accent-gold);
    }

    .document-content {
        padding: 0.75rem 2rem;
        flex: 1;
        display: grid;
        grid-template-columns: 180px 1fr 200px;
        gap: 2rem;
        align-items: center;
        min-width: 0;
    }

    .document-header {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 0;
    }

    .document-source {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        font-size: 0.6rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-left: 2px solid;
    }

    .source-instagram { color: #E1306C; border-color: #E1306C; background: rgba(225, 48, 108, 0.1); }
    .source-twitter { color: #1DA1F2; border-color: #1DA1F2; background: rgba(29, 161, 242, 0.1); }
    .source-perplexity { color: #20B2AA; border-color: #20B2AA; background: rgba(32, 178, 170, 0.1); }
    .source-attachment { color: #6C757D; border-color: #6C757D; background: rgba(108, 117, 125, 0.1); }
    .source-google_drive { color: #4285F4; border-color: #4285F4; background: rgba(66, 133, 244, 0.1); }
    .source-web_import { color: var(--accent-gold); border-color: var(--accent-gold); background: rgba(212, 165, 116, 0.1); }
    .source-ai_conversation { color: var(--accent-warm); border-color: var(--accent-warm); background: rgba(244, 162, 97, 0.1); }

    .document-title {
        font-family: 'Crimson Pro', serif;
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .document-preview-area {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-width: 0;
    }

    .document-preview {
        color: var(--text-secondary);
        font-size: 0.85rem;
        line-height: 1.7;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        font-weight: 300;
    }

    .document-excerpt {
        color: var(--text-primary);
        font-size: 0.9rem;
        line-height: 1.6;
        font-style: italic;
        opacity: 0.9;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .document-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .tag {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        padding: 0.2rem 0.5rem;
        font-size: 0.65rem;
        color: var(--text-tertiary);
        font-weight: 300;
        letter-spacing: 0.02em;
    }

    .document-meta-column {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
        text-align: right;
    }

    .document-meta {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        font-size: 0.7rem;
        color: var(--text-tertiary);
        font-weight: 300;
    }

    .document-date {
        color: var(--accent-dim);
        font-size: 0.75rem;
    }

    .document-id {
        color: var(--text-tertiary);
        font-family: 'Courier New', monospace;
        font-size: 0.65rem;
        opacity: 0.5;
    }

    .document-stats {
        color: var(--text-tertiary);
        font-size: 0.7rem;
    }

    .section-header {
        font-family: 'Crimson Pro', serif;
        font-size: 2rem;
        font-weight: 300;
        margin-bottom: 2rem;
        color: var(--text-primary);
        letter-spacing: -0.02em;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
        position: relative;
    }

    .section-header::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 80px;
        height: 2px;
        background: var(--accent-gold);
    }

    .no-results {
        text-align: center;
        padding: 6rem 2rem;
        color: var(--text-tertiary);
    }

    .no-results p {
        font-family: 'Crimson Pro', serif;
        font-size: 1.5rem;
        font-weight: 300;
        font-style: italic;
    }

    /* Image Links Modal */
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 10, 10, 0.95);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .image-modal.active {
        display: flex;
    }

    .image-modal-content {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 2.5rem;
        max-width: 600px;
        width: 90%;
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    .image-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .image-modal-title {
        font-family: 'Crimson Pro', serif;
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--accent-gold);
        flex: 1;
    }

    .image-modal-subtitle {
        font-size: 0.85rem;
        color: var(--text-tertiary);
        margin-top: 0.5rem;
        font-weight: 400;
    }

    .image-modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 2rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        transition: color 0.3s ease;
    }

    .image-modal-close:hover {
        color: var(--accent-warm);
    }

    .image-links-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .image-link-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .image-link-item:hover {
        border-color: var(--accent-gold);
        background: var(--bg-primary);
        transform: translateX(4px);
    }

    .image-link-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .image-link-content {
        flex: 1;
        min-width: 0;
    }

    .image-link-label {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .image-link-url {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        font-family: 'Courier New', monospace;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .image-link-arrow {
        color: var(--accent-gold);
        font-size: 1.2rem;
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
{% if documents %}
<!-- Bulk Actions Bar -->
<div class="bulk-actions" id="bulkActions">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
        <input type="checkbox" id="selectAllCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
        <span style="font-size: 0.8rem; color: var(--text-secondary);">Select All</span>
    </label>

    <button class="action-btn danger" id="deleteBtn" onclick="deleteSelected()" disabled>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 0.35rem;">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        Delete
    </button>

    <div class="selection-info">
        <span class="selection-count" id="selectionCount">0 selected</span>
        <span class="selection-hint">Shift+Click for range selection</span>
    </div>
</div>

<div class="document-grid" id="documentGrid">
    {% for doc in documents %}
    <div class="document-card" data-doc-id="{{ doc.id }}" data-index="{{ loop.index0 }}">
        <input type="checkbox" class="document-checkbox" data-doc-id="{{ doc.id }}" data-index="{{ loop.index0 }}">
        <div class="document-inner" style="height: 100%; display: flex; flex-direction: inherit;">
        {% if doc.media_files %}
            <img src="/media/{{ doc.media_files[0] }}"
                 alt="{{ doc.title }}"
                 class="document-image"
                 onclick="showImageLinks(event, '{{ doc.marketplace_url }}', {{ doc.ipfs_links|tojson }}, {{ doc.ipfs_gateways|tojson }}, {{ doc.image_urls|tojson }}, '{{ doc.domain }}', '{{ doc.title|replace("'", "\\'") }}')"
                 title="Click to view source links">
        {% elif doc.images %}
            <img src="{{ doc.images[0] }}"
                 alt="{{ doc.title }}"
                 class="document-image"
                 onclick="showImageLinks(event, '{{ doc.marketplace_url }}', {{ doc.ipfs_links|tojson }}, {{ doc.ipfs_gateways|tojson }}, {{ doc.image_urls|tojson }}, '{{ doc.domain }}', '{{ doc.title|replace("'", "\\'") }}')"
                 title="Click to view source links">
        {% else %}
            <div class="document-image"
                 style="display: flex; align-items: center; justify-content: center; font-size: 3rem; opacity: 0.2;"
                 onclick="showImageLinks(event, '{{ doc.marketplace_url }}', {{ doc.ipfs_links|tojson }}, {{ doc.ipfs_gateways|tojson }}, {{ doc.image_urls|tojson }}, '{{ doc.domain }}', '{{ doc.title|replace("'", "\\'") }}')"
                 title="Click to view source links">
                {% if doc.source == 'instagram' %}üì∑
                {% elif doc.source == 'twitter' %}üê¶
                {% elif doc.source == 'perplexity' %}üîç
                {% elif doc.source == 'attachment' %}üìÑ
                {% elif doc.source == 'ai_conversation' %}üí¨
                {% else %}üìö
                {% endif %}
            </div>
        {% endif %}

        <div class="document-content">
            <div class="document-header">
                <span class="document-source source-{{ doc.source }}">{{ doc.source.replace('_', ' ') }}</span>
                <h3 class="document-title">{{ doc.title }}</h3>
            </div>

            <div class="document-preview-area">
                <p class="document-preview">{{ doc.preview[:200] }}...</p>
                {% if doc.tags %}
                <div class="document-tags">
                    {% for tag in doc.tags[:4] %}
                    <a href="/tags#{{ tag }}" class="tag" style="text-decoration: none; color: inherit; transition: all 0.3s ease;" onmouseover="this.style.borderColor='var(--accent-gold)'; this.style.color='var(--accent-gold)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-tertiary)';" onclick="event.stopPropagation();">#{{ tag }}</a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="document-meta-column">
                {% if doc.date %}
                <span class="document-date">{{ doc.date[:10] }}</span>
                {% endif %}
                <span class="document-id">{{ doc.id[:8] }}</span>
            </div>
        </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
// Sophisticated Document Selection System
class DocumentSelector {
    constructor() {
        this.cards = Array.from(document.querySelectorAll('.document-card'));
        this.checkboxes = document.querySelectorAll('.document-checkbox');
        this.deleteBtn = document.getElementById('deleteBtn');
        this.selectAllCheckbox = document.getElementById('selectAllCheckbox');
        this.selectionCount = document.getElementById('selectionCount');
        this.bulkActions = document.getElementById('bulkActions');

        this.lastSelectedIndex = -1;
        this.focusedIndex = -1;

        this.init();
    }

    init() {
        // Store index on each card and checkbox for easy retrieval
        this.cards.forEach((card, index) => {
            card.dataset.index = index;
        });

        this.checkboxes.forEach((checkbox, index) => {
            checkbox.dataset.index = index;
        });

        // Checkbox click handlers (need to use click, not change, to capture shift key)
        this.checkboxes.forEach((checkbox, index) => {
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card click from firing

                if (e.shiftKey && this.lastSelectedIndex !== -1) {
                    // Shift-click on checkbox: range select
                    e.preventDefault();
                    console.log('Shift-click on checkbox. Range from', this.lastSelectedIndex, 'to', index);
                    this.selectRange(this.lastSelectedIndex, index);
                    this.updateUI();
                } else {
                    // Normal checkbox click
                    this.lastSelectedIndex = index;
                    console.log('Normal checkbox click at index:', index);
                    // Let the checkbox toggle naturally
                    setTimeout(() => this.updateUI(), 0);
                }
            });
        });

        // Card click handlers with shift/cmd support
        this.cards.forEach((card, index) => {
            card.addEventListener('click', (e) => this.handleCardClick(e, index));
            card.setAttribute('tabindex', '0');
            card.addEventListener('keydown', (e) => this.handleCardKeydown(e, index));
        });

        // Select all checkbox handler
        if (this.selectAllCheckbox) {
            this.selectAllCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    this.selectAll();
                } else {
                    this.clearSelection();
                }
            });
        }

        // Select all via keyboard shortcut (Cmd/Ctrl+A) handled in handleGlobalKeydown

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => this.handleGlobalKeydown(e));

        this.updateUI();
    }

    handleCardClick(e, index) {
        // Don't interfere with checkbox clicks - let them handle themselves
        if (e.target.classList.contains('document-checkbox')) {
            return;
        }

        const checkbox = this.checkboxes[index];
        const card = this.cards[index];

        if (e.shiftKey) {
            // SHIFT-CLICK: Range selection
            e.preventDefault();
            e.stopPropagation();

            console.log('Shift-click detected. Index:', index, 'Last:', this.lastSelectedIndex);

            if (this.lastSelectedIndex === -1) {
                // No previous selection, select this one and make it the anchor
                checkbox.checked = true;
                this.lastSelectedIndex = index;
                console.log('First shift-click, selecting index:', index);
            } else {
                // Select range from last to current
                console.log('Range selecting from', this.lastSelectedIndex, 'to', index);
                this.selectRange(this.lastSelectedIndex, index);
                // Don't update lastSelectedIndex - keep the anchor point
            }

            this.focusedIndex = index;
            this.updateFocus();
            this.updateUI();

        } else if (e.metaKey || e.ctrlKey) {
            // CMD/CTRL-CLICK: Toggle individual selection
            e.preventDefault();
            e.stopPropagation();

            checkbox.checked = !checkbox.checked;
            this.lastSelectedIndex = index; // Update anchor for next shift-click

            this.focusedIndex = index;
            this.updateFocus();
            this.updateUI();

        } else {
            // NORMAL CLICK: Navigate to document
            const docId = card.dataset.docId;
            window.location.href = '/document/' + docId;
        }
    }

    handleCardKeydown(e, index) {
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.navigateDown();
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.navigateUp();
                break;
            case 'Enter':
                e.preventDefault();
                window.location.href = '/document/' + this.cards[index].dataset.docId;
                break;
            case ' ':
                e.preventDefault();
                this.checkboxes[index].checked = !this.checkboxes[index].checked;
                this.lastSelectedIndex = index;
                this.updateUI();
                break;
        }
    }

    handleGlobalKeydown(e) {
        // Cmd/Ctrl + A - Select all
        if ((e.metaKey || e.ctrlKey) && e.key === 'a') {
            e.preventDefault();
            this.selectAll();
        }

        // Escape - Clear selection
        if (e.key === 'Escape') {
            e.preventDefault();
            this.clearSelection();
        }

        // Delete - Delete selected
        if ((e.key === 'Delete' || e.key === 'Backspace') && !e.target.matches('input, textarea')) {
            e.preventDefault();
            const selected = this.getSelectedCount();
            if (selected > 0) {
                deleteSelected();
            }
        }

        // ? - Toggle help
        if (e.key === '?' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            toggleHelp();
        }
    }

    navigateDown() {
        if (this.focusedIndex < this.cards.length - 1) {
            this.focusedIndex++;
            this.cards[this.focusedIndex].focus();
            this.updateFocus();
        }
    }

    navigateUp() {
        if (this.focusedIndex > 0) {
            this.focusedIndex--;
            this.cards[this.focusedIndex].focus();
            this.updateFocus();
        }
    }

    updateFocus() {
        this.cards.forEach((card, i) => {
            if (i === this.focusedIndex) {
                card.classList.add('focused');
            } else {
                card.classList.remove('focused');
            }
        });
    }

    selectRange(start, end) {
        const [min, max] = [Math.min(start, end), Math.max(start, end)];
        console.log('Selecting range:', min, 'to', max);

        for (let i = min; i <= max; i++) {
            this.checkboxes[i].checked = true;
            console.log('Selected checkbox at index:', i);
        }

        // Don't update lastSelectedIndex - keep the anchor point for continuous range selection
    }

    selectAll() {
        this.checkboxes.forEach(cb => cb.checked = true);
        this.updateUI();
    }

    clearSelection() {
        this.checkboxes.forEach(cb => cb.checked = false);
        this.updateUI();
    }

    getSelectedCount() {
        return Array.from(this.checkboxes).filter(cb => cb.checked).length;
    }

    updateUI() {
        const count = this.getSelectedCount();
        const total = this.checkboxes.length;

        // Update button states
        if (this.deleteBtn) {
            this.deleteBtn.disabled = count === 0;
        }

        // Update selection count display
        if (this.selectionCount) {
            this.selectionCount.textContent = count === 0 ? '0 selected' :
                count === 1 ? '1 selected' : `${count} selected`;
        }

        // Update select-all checkbox state
        if (this.selectAllCheckbox) {
            if (count === 0) {
                this.selectAllCheckbox.checked = false;
                this.selectAllCheckbox.indeterminate = false;
            } else if (count === total) {
                this.selectAllCheckbox.checked = true;
                this.selectAllCheckbox.indeterminate = false;
            } else {
                this.selectAllCheckbox.checked = false;
                this.selectAllCheckbox.indeterminate = true;
            }
        }

        // Show/hide bulk actions bar
        if (this.bulkActions) {
            if (count > 0) {
                this.bulkActions.classList.add('has-selection');
            } else {
                this.bulkActions.classList.remove('has-selection');
            }
        }

        // Update card styling
        this.cards.forEach((card, index) => {
            if (this.checkboxes[index].checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }
}

// Initialize selection system
const selector = new DocumentSelector();

// Action functions (kept for backward compatibility)
function clearSelection() {
    selector.clearSelection();
}

function invertSelection() {
    selector.checkboxes.forEach(cb => cb.checked = !cb.checked);
    selector.updateUI();
}

async function deleteSelected() {
    const selected = Array.from(document.querySelectorAll('.document-checkbox:checked'))
        .map(cb => cb.dataset.docId);

    if (selected.length === 0) return;

    const confirmMsg = selected.length === 1
        ? 'Delete 1 document?'
        : `Delete ${selected.length} documents?`;

    if (!confirm(confirmMsg)) return;

    selector.deleteBtn.disabled = true;
    selector.deleteBtn.textContent = 'Deleting...';

    try {
        const response = await fetch('/api/delete-documents', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ doc_ids: selected })
        });

        const result = await response.json();

        if (result.success) {
            // Remove deleted cards from UI
            selected.forEach(id => {
                const card = document.querySelector(`[data-doc-id="${id}"]`);
                if (card) card.remove();
            });

            // Reload if no documents left
            if (document.querySelectorAll('.document-card').length === 0) {
                window.location.reload();
            } else {
                // Reinitialize selector with new cards
                location.reload();
            }
        } else {
            alert('Error deleting documents: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting documents: ' + error);
    } finally {
        selector.deleteBtn.disabled = false;
        selector.deleteBtn.textContent = 'Delete';
    }
}

// Help toggle
function toggleHelp() {
    const shortcuts = document.getElementById('keyboardShortcuts');
    shortcuts.classList.toggle('visible');
}
</script>
<!-- Keyboard Shortcuts Panel -->
<button class="help-toggle" id="helpToggle" onclick="toggleHelp()">?</button>
<div class="keyboard-shortcuts" id="keyboardShortcuts">
    <h3>Keyboard Shortcuts</h3>
    <div class="shortcut-list">
        <div class="shortcut-item">
            <span class="shortcut-desc">Select all documents</span>
            <span class="shortcut-key">‚åò/Ctrl + A</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">Clear selection</span>
            <span class="shortcut-key">Esc</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">Delete selected</span>
            <span class="shortcut-key">Delete</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">Navigate documents</span>
            <span class="shortcut-key">‚Üë ‚Üì</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">Range select</span>
            <span class="shortcut-key">Shift + Click</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">Multi-select</span>
            <span class="shortcut-key">‚åò/Ctrl + Click</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">Open document</span>
            <span class="shortcut-key">Enter</span>
        </div>
        <div class="shortcut-item">
            <span class="shortcut-desc">Toggle shortcuts</span>
            <span class="shortcut-key">?</span>
        </div>
    </div>
</div>

<!-- Image Links Modal -->
<div class="image-modal" id="imageModal">
    <div class="image-modal-content">
        <div class="image-modal-header">
            <div>
                <h3 class="image-modal-title" id="modalTitle">View Source</h3>
                <p class="image-modal-subtitle">Click any link to open in new tab</p>
            </div>
            <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
        </div>
        <div class="image-links-list" id="imageLinksContainer">
            <!-- Links will be populated here -->
        </div>
    </div>
</div>

<script>
function showImageLinks(event, marketplaceUrl, ipfsLinks, ipfsGateways, imageUrls, domain, title) {
    event.stopPropagation();
    event.preventDefault();

    const modal = document.getElementById('imageModal');
    const modalTitle = document.getElementById('modalTitle');
    const container = document.getElementById('imageLinksContainer');

    modalTitle.textContent = title || 'View Source';

    // Build links list
    let linksHTML = '';

    // Add marketplace link
    if (marketplaceUrl) {
        const marketplaceName = domain.includes('foundation') ? 'Foundation NFT Platform' :
                               domain.includes('1stdibs') ? '1stDibs Marketplace' :
                               domain.includes('opensea') ? 'OpenSea NFT Platform' :
                               domain.includes('rarible') ? 'Rarible NFT Platform' :
                               domain.includes('superrare') ? 'SuperRare NFT Platform' :
                               'Original Platform';
        linksHTML += `
            <a href="${marketplaceUrl}" target="_blank" class="image-link-item">
                <span class="image-link-icon">üè™</span>
                <div class="image-link-content">
                    <div class="image-link-label">${marketplaceName}</div>
                    <div class="image-link-url">${marketplaceUrl}</div>
                </div>
                <span class="image-link-arrow">‚Üí</span>
            </a>
        `;
    }

    // Add IPFS gateway links
    if (ipfsGateways && ipfsGateways.length > 0) {
        ipfsGateways.forEach((gateway, index) => {
            const gatewayName = gateway.includes('ipfs.io') ? 'IPFS Original (ipfs.io)' :
                               gateway.includes('pinata') ? 'IPFS Original (Pinata)' :
                               gateway.includes('cloudflare') ? 'IPFS Original (Cloudflare)' :
                               'IPFS Original';
            linksHTML += `
                <a href="${gateway}" target="_blank" class="image-link-item">
                    <span class="image-link-icon">üîó</span>
                    <div class="image-link-content">
                        <div class="image-link-label">${gatewayName}</div>
                        <div class="image-link-url">${gateway}</div>
                    </div>
                    <span class="image-link-arrow">‚Üí</span>
                </a>
            `;
        });
    }

    // Add IPFS protocol links
    if (ipfsLinks && ipfsLinks.length > 0) {
        ipfsLinks.forEach((ipfs, index) => {
            const ipfsHash = ipfs.replace('ipfs://', '');
            const gatewayUrl = `https://ipfs.io/ipfs/${ipfsHash}`;
            linksHTML += `
                <a href="${gatewayUrl}" target="_blank" class="image-link-item">
                    <span class="image-link-icon">üîó</span>
                    <div class="image-link-content">
                        <div class="image-link-label">IPFS Original (Decentralized)</div>
                        <div class="image-link-url">${ipfs}</div>
                    </div>
                    <span class="image-link-arrow">‚Üí</span>
                </a>
            `;
        });
    }

    // Add original image URLs
    if (imageUrls && imageUrls.length > 0) {
        imageUrls.forEach((url, index) => {
            const urlDomain = new URL(url).hostname;
            const isIPFS = url.includes('ipfs') || url.includes('gateway');
            const label = isIPFS ? `IPFS Original ${imageUrls.length > 1 ? index + 1 : ''}` :
                         `Source Image ${imageUrls.length > 1 ? index + 1 : ''}`;
            linksHTML += `
                <a href="${url}" target="_blank" class="image-link-item">
                    <span class="image-link-icon">${isIPFS ? 'üîó' : 'üñºÔ∏è'}</span>
                    <div class="image-link-content">
                        <div class="image-link-label">${label}</div>
                        <div class="image-link-url">${url}</div>
                    </div>
                    <span class="image-link-arrow">‚Üí</span>
                </a>
            `;
        });
    }

    if (linksHTML === '') {
        linksHTML = `
            <div style="text-align: center; color: var(--text-tertiary); padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                <div style="margin-bottom: 0.5rem; font-weight: 500;">No external links found</div>
                <div style="font-size: 0.85rem;">This document may not have platform or IPFS links yet</div>
            </div>
        `;
    }

    container.innerHTML = linksHTML;
    modal.classList.add('active');
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.classList.remove('active');
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// Close modal on background click
document.getElementById('imageModal').addEventListener('click', (e) => {
    if (e.target.id === 'imageModal') {
        closeImageModal();
    }
});
</script>

{% else %}
<div class="no-results">
    <p>No documents in this collection.</p>
</div>
{% endif %}
{% endblock %}
