{% extends "base.html" %}

{% block title %}Edition Constellation - ARCHIV-IT{% endblock %}

{% block extra_styles %}
<style>
    .constellation-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .constellation-header h1 {
        font-family: 'Crimson Pro', serif;
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .constellation-subtitle {
        color: var(--text-tertiary);
        font-size: 0.85rem;
    }

    /* Main Layout */
    .constellation-layout {
        display: grid;
        grid-template-columns: 280px 1fr 300px;
        gap: 1rem;
        height: calc(100vh - 250px);
        min-height: 600px;
    }

    /* Left Sidebar - Edition Selector */
    .edition-selector {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 1rem;
        overflow-y: auto;
    }

    .selector-title {
        font-family: 'Crimson Pro', serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--accent-gold);
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .edition-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .edition-item {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .edition-item:hover {
        border-color: var(--accent-gold);
        background: rgba(212, 165, 116, 0.05);
    }

    .edition-item.active {
        border-color: var(--accent-gold);
        background: rgba(212, 165, 116, 0.1);
    }

    .edition-item-title {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.3rem;
    }

    .edition-item-meta {
        font-size: 0.65rem;
        color: var(--text-tertiary);
        display: flex;
        gap: 0.75rem;
    }

    .edition-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.15rem 0.4rem;
        font-size: 0.6rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-radius: 2px;
    }

    .badge-1155 {
        background: rgba(209, 102, 255, 0.2);
        color: #d166ff;
        border: 1px solid rgba(209, 102, 255, 0.4);
    }

    .badge-721 {
        background: rgba(102, 178, 255, 0.2);
        color: #66b2ff;
        border: 1px solid rgba(102, 178, 255, 0.4);
    }

    /* Main Visualization Area */
    .constellation-view {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    #constellationCanvas {
        width: 100%;
        height: 100%;
    }

    /* Constellation Controls */
    .constellation-controls {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        z-index: 10;
        opacity: 0.4;
        transition: opacity 0.3s ease;
    }

    .constellation-controls:hover {
        opacity: 1;
    }

    .const-btn {
        background: rgba(22, 22, 22, 0.8);
        border: 1px solid var(--border-color);
        color: var(--text-tertiary);
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        font-size: 0.65rem;
        font-weight: 400;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        backdrop-filter: blur(5px);
    }

    .const-btn:hover {
        border-color: var(--accent-gold);
        color: var(--accent-gold);
    }

    /* Legend */
    .constellation-legend {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        background: rgba(22, 22, 22, 0.95);
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        font-size: 0.65rem;
        backdrop-filter: blur(10px);
    }

    .legend-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.35rem;
        color: var(--text-tertiary);
    }

    .legend-row:last-child {
        margin-bottom: 0;
    }

    .legend-icon {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .legend-icon.artwork {
        background: radial-gradient(circle at 30% 30%, #d4a574, #8b7355);
        box-shadow: 0 0 10px rgba(212, 165, 116, 0.6);
    }
    .legend-icon.holder {
        background: rgba(102, 178, 255, 0.8);
        border: 1px solid #66b2ff;
    }
    .legend-icon.active {
        background: rgba(102, 255, 178, 0.8);
        border: 1px solid #66ffb2;
    }
    .legend-icon.seller {
        background: rgba(255, 102, 153, 0.8);
        border: 1px solid #ff6699;
    }

    .legend-line {
        width: 20px;
        height: 2px;
        flex-shrink: 0;
    }

    .legend-line.primary { background: rgba(212, 165, 116, 0.6); }
    .legend-line.secondary { background: rgba(255, 255, 255, 0.2); }

    /* Right Sidebar - Collector Details */
    .collector-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 1rem;
        overflow-y: auto;
    }

    .panel-title {
        font-family: 'Crimson Pro', serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--accent-gold);
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .edition-stats {
        background: rgba(212, 165, 116, 0.05);
        border: 1px solid rgba(212, 165, 116, 0.2);
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .stat-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-family: 'Crimson Pro', serif;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--accent-gold);
    }

    .stat-label {
        font-size: 0.6rem;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Collector List */
    .collector-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .collector-item {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .collector-item:hover {
        border-color: var(--accent-gold);
        background: rgba(212, 165, 116, 0.05);
    }

    .collector-item.highlighted {
        border-color: #66b2ff;
        background: rgba(102, 178, 255, 0.1);
    }

    .collector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.4rem;
    }

    .collector-address {
        font-family: monospace;
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .collector-editions {
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--accent-gold);
        padding: 0.15rem 0.4rem;
        background: rgba(212, 165, 116, 0.15);
        border-radius: 2px;
    }

    .collector-metrics {
        display: flex;
        gap: 0.75rem;
        font-size: 0.6rem;
        color: var(--text-tertiary);
    }

    .metric {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .metric-icon {
        color: var(--accent-warm);
        font-size: 0.55rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-tertiary);
    }

    .empty-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    /* Node Styles in SVG */
    .artwork-node {
        cursor: pointer;
    }

    .collector-node {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .collector-node:hover {
        filter: brightness(1.3);
    }

    /* Glow Effects */
    .glow-gold {
        filter: drop-shadow(0 0 8px rgba(212, 165, 116, 0.6));
    }

    .glow-blue {
        filter: drop-shadow(0 0 6px rgba(102, 178, 255, 0.5));
    }

    /* Transfer Flow Animation */
    @keyframes flowPulse {
        0% { stroke-dashoffset: 20; }
        100% { stroke-dashoffset: 0; }
    }

    .flow-line {
        stroke-dasharray: 5 5;
        animation: flowPulse 1s linear infinite;
    }

    /* Provenance Timeline */
    .provenance-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .provenance-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--accent-gold);
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .provenance-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.65rem;
    }

    .provenance-date {
        color: var(--text-tertiary);
        width: 70px;
        flex-shrink: 0;
    }

    .provenance-event {
        color: var(--text-secondary);
        flex: 1;
    }

    .provenance-value {
        color: var(--accent-warm);
        font-weight: 500;
    }

    /* Value Trajectory Indicators */
    .trajectory-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.6rem;
        padding: 0.15rem 0.35rem;
        border-radius: 2px;
    }

    .trajectory-up {
        background: rgba(102, 255, 178, 0.15);
        color: #66ffb2;
    }

    .trajectory-down {
        background: rgba(255, 102, 153, 0.15);
        color: #ff6699;
    }

    .trajectory-stable {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-tertiary);
    }
</style>
{% endblock %}

{% block content %}
<div class="constellation-header">
    <h1>Edition Constellation</h1>
    <p class="constellation-subtitle">Collector Distribution Network for Multi-Edition Works</p>
</div>

<div class="constellation-layout">
    <!-- Left: Edition Selector -->
    <div class="edition-selector">
        <div class="selector-title">Edition Works</div>
        <div class="edition-list" id="editionList">
            <div class="empty-state">
                <div class="empty-icon">--</div>
                <div>Loading edition works...</div>
            </div>
        </div>
    </div>

    <!-- Center: Constellation Visualization -->
    <div class="constellation-view">
        <svg id="constellationCanvas"></svg>

        <div class="constellation-controls">
            <button class="const-btn" onclick="resetConstellation()">Reset</button>
            <button class="const-btn" onclick="toggleLabels()">Labels</button>
            <button class="const-btn" onclick="animateFlow()">Flow</button>
        </div>

        <div class="constellation-legend">
            <div class="legend-row">
                <div class="legend-icon artwork"></div>
                <span>Artwork (Central)</span>
            </div>
            <div class="legend-row">
                <div class="legend-icon holder"></div>
                <span>Current Holder</span>
            </div>
            <div class="legend-row">
                <div class="legend-icon active"></div>
                <span>Active Collector</span>
            </div>
            <div class="legend-row">
                <div class="legend-icon seller"></div>
                <span>Previous Owner</span>
            </div>
            <div class="legend-row">
                <div class="legend-line primary"></div>
                <span>Direct Ownership</span>
            </div>
            <div class="legend-row">
                <div class="legend-line secondary"></div>
                <span>Transfer Path</span>
            </div>
        </div>
    </div>

    <!-- Right: Collector Details -->
    <div class="collector-panel">
        <div class="panel-title">Edition Distribution</div>

        <div class="edition-stats" id="editionStats">
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalEditions">--</div>
                    <div class="stat-label">Total Editions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uniqueHolders">--</div>
                    <div class="stat-label">Unique Holders</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgHoldDays">--</div>
                    <div class="stat-label">Avg Hold (days)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalVolume">--</div>
                    <div class="stat-label">Volume (ETH)</div>
                </div>
            </div>
        </div>

        <div class="panel-title" style="margin-top: 1rem;">Collectors</div>
        <div class="collector-list" id="collectorList">
            <div class="empty-state">
                <div class="empty-icon">--</div>
                <div>Select an edition work</div>
            </div>
        </div>

        <div class="provenance-section" id="provenanceSection" style="display: none;">
            <div class="provenance-title">Recent Activity</div>
            <div id="provenanceList"></div>
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Global state
let editionData = null;
let selectedEdition = null;
let showLabels = true;
let simulation;
let svg, g;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadEditionWorks();
});

// Load edition works from API
async function loadEditionWorks() {
    try {
        const response = await fetch('/api/edition-works');
        const data = await response.json();

        if (data.error) {
            showError('editionList', data.error);
            return;
        }

        renderEditionList(data.editions || []);
    } catch (error) {
        console.error('Failed to load editions:', error);
        showError('editionList', 'Failed to load edition works');
    }
}

// Render edition list
function renderEditionList(editions) {
    const container = document.getElementById('editionList');

    if (editions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">--</div>
                <div>No edition works found</div>
                <div style="font-size: 0.65rem; margin-top: 0.5rem; color: var(--text-tertiary);">
                    ERC-1155 tokens will appear here
                </div>
            </div>
        `;
        return;
    }

    container.innerHTML = editions.map((edition, index) => `
        <div class="edition-item" onclick="selectEdition('${edition.contract}', ${edition.token_id})"
             data-contract="${edition.contract}" data-token="${edition.token_id}">
            <div class="edition-item-title">${edition.title || 'Untitled Edition'}</div>
            <div class="edition-item-meta">
                <span class="edition-badge ${edition.token_standard === 'ERC-1155' ? 'badge-1155' : 'badge-721'}">
                    ${edition.token_standard || 'ERC-1155'}
                </span>
                <span>${edition.total_supply || '?'} editions</span>
                <span>${edition.unique_holders || '?'} holders</span>
            </div>
        </div>
    `).join('');
}

// Select an edition to visualize
async function selectEdition(contract, tokenId) {
    // Update UI selection state
    document.querySelectorAll('.edition-item').forEach(el => el.classList.remove('active'));
    const selected = document.querySelector(`.edition-item[data-contract="${contract}"][data-token="${tokenId}"]`);
    if (selected) selected.classList.add('active');

    // Load edition data
    try {
        const response = await fetch(`/api/edition-constellation/${contract}/${tokenId}`);
        const data = await response.json();

        if (data.error) {
            showError('collectorList', data.error);
            return;
        }

        editionData = data;
        selectedEdition = { contract, tokenId };

        // Update stats
        updateStats(data);

        // Render collector list
        renderCollectorList(data.collectors || []);

        // Render constellation visualization
        renderConstellation(data);

        // Show provenance
        renderProvenance(data.recent_activity || []);

    } catch (error) {
        console.error('Failed to load edition data:', error);
        showError('collectorList', 'Failed to load constellation data');
    }
}

// Update edition stats
function updateStats(data) {
    document.getElementById('totalEditions').textContent = data.total_supply || '--';
    document.getElementById('uniqueHolders').textContent = data.unique_holders || '--';
    document.getElementById('avgHoldDays').textContent = data.avg_hold_days ? Math.round(data.avg_hold_days) : '--';
    document.getElementById('totalVolume').textContent = data.total_volume_eth ? data.total_volume_eth.toFixed(2) : '--';
}

// Render collector list
function renderCollectorList(collectors) {
    const container = document.getElementById('collectorList');

    if (collectors.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">--</div>
                <div>No collector data available</div>
            </div>
        `;
        return;
    }

    container.innerHTML = collectors.map(collector => {
        const shortAddr = `${collector.address.substring(0, 6)}...${collector.address.substring(collector.address.length - 4)}`;
        const trajectory = collector.value_change > 0 ? 'up' : collector.value_change < 0 ? 'down' : 'stable';
        const trajectoryIcon = trajectory === 'up' ? '+' : trajectory === 'down' ? '-' : '=';

        return `
            <div class="collector-item" onclick="highlightCollector('${collector.address}')"
                 data-address="${collector.address}">
                <div class="collector-header">
                    <span class="collector-address">${shortAddr}</span>
                    <span class="collector-editions">${collector.editions_held} ed.</span>
                </div>
                <div class="collector-metrics">
                    <span class="metric">
                        <span class="metric-icon">H</span>
                        ${collector.hold_days || 0}d
                    </span>
                    <span class="metric">
                        <span class="metric-icon">V</span>
                        ${collector.volume_eth ? collector.volume_eth.toFixed(3) : '0'}
                    </span>
                    <span class="trajectory-indicator trajectory-${trajectory}">
                        ${trajectoryIcon}${Math.abs(collector.value_change || 0).toFixed(1)}%
                    </span>
                </div>
            </div>
        `;
    }).join('');
}

// Render provenance timeline
function renderProvenance(activity) {
    const section = document.getElementById('provenanceSection');
    const container = document.getElementById('provenanceList');

    if (activity.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    container.innerHTML = activity.slice(0, 10).map(event => `
        <div class="provenance-item">
            <span class="provenance-date">${formatDate(event.timestamp)}</span>
            <span class="provenance-event">${event.type}</span>
            ${event.value_eth ? `<span class="provenance-value">${event.value_eth.toFixed(3)} ETH</span>` : ''}
        </div>
    `).join('');
}

// Render constellation visualization
function renderConstellation(data) {
    const container = document.getElementById('constellationCanvas');
    const width = container.clientWidth;
    const height = container.clientHeight;

    // Clear existing
    d3.select('#constellationCanvas').selectAll('*').remove();

    // Create SVG
    svg = d3.select('#constellationCanvas')
        .attr('width', width)
        .attr('height', height);

    // Define gradients
    const defs = svg.append('defs');

    // Artwork glow gradient
    const artworkGradient = defs.append('radialGradient')
        .attr('id', 'artworkGlow')
        .attr('cx', '30%')
        .attr('cy', '30%');
    artworkGradient.append('stop').attr('offset', '0%').attr('stop-color', '#d4a574');
    artworkGradient.append('stop').attr('offset', '100%').attr('stop-color', '#8b7355');

    // Add zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.3, 5])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
        });

    svg.call(zoom);

    // Create container group
    g = svg.append('g');

    // Build nodes and links
    const nodes = buildNodes(data);
    const links = buildLinks(data, nodes);

    // Create force simulation
    simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(d => d.distance || 100))
        .force('charge', d3.forceManyBody().strength(-200))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(d => d.radius + 10));

    // Create links
    const link = g.append('g')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('stroke', d => d.type === 'ownership' ? 'rgba(212, 165, 116, 0.4)' : 'rgba(255, 255, 255, 0.15)')
        .attr('stroke-width', d => d.type === 'ownership' ? 2 : 1)
        .attr('stroke-dasharray', d => d.type === 'transfer' ? '3 3' : 'none');

    // Create nodes
    const node = g.append('g')
        .selectAll('g')
        .data(nodes)
        .join('g')
        .attr('class', d => d.type === 'artwork' ? 'artwork-node' : 'collector-node')
        .call(drag(simulation))
        .on('click', (event, d) => {
            if (d.type === 'collector') {
                highlightCollector(d.address);
            }
        });

    // Artwork central node (larger, glowing)
    node.filter(d => d.type === 'artwork')
        .append('circle')
        .attr('r', 30)
        .attr('fill', 'url(#artworkGlow)')
        .attr('class', 'glow-gold');

    // Collector nodes
    node.filter(d => d.type === 'collector')
        .append('circle')
        .attr('r', d => Math.max(8, Math.min(20, 8 + d.editions * 3)))
        .attr('fill', d => d.isHolder ? 'rgba(102, 178, 255, 0.6)' : 'rgba(255, 102, 153, 0.4)')
        .attr('stroke', d => d.isHolder ? '#66b2ff' : '#ff6699')
        .attr('stroke-width', 2);

    // Labels
    const label = g.append('g')
        .selectAll('text')
        .data(nodes)
        .join('text')
        .text(d => d.type === 'artwork' ? d.title.substring(0, 15) : `${d.address.substring(0, 6)}...`)
        .attr('font-size', d => d.type === 'artwork' ? 11 : 9)
        .attr('fill', d => d.type === 'artwork' ? 'var(--accent-gold)' : 'var(--text-tertiary)')
        .attr('text-anchor', 'middle')
        .attr('dy', d => d.type === 'artwork' ? 45 : -15)
        .style('pointer-events', 'none')
        .style('display', showLabels ? 'block' : 'none');

    // Update positions on tick
    simulation.on('tick', () => {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);

        label
            .attr('x', d => d.x)
            .attr('y', d => d.y);
    });
}

// Build nodes from edition data
function buildNodes(data) {
    const nodes = [];

    // Central artwork node
    nodes.push({
        id: 'artwork',
        type: 'artwork',
        title: data.title || 'Edition Work',
        radius: 30,
        fx: null,
        fy: null
    });

    // Collector nodes
    (data.collectors || []).forEach(collector => {
        nodes.push({
            id: collector.address,
            type: 'collector',
            address: collector.address,
            editions: collector.editions_held || 1,
            isHolder: collector.is_current_holder,
            holdDays: collector.hold_days || 0,
            volumeEth: collector.volume_eth || 0,
            radius: Math.max(8, Math.min(20, 8 + (collector.editions_held || 1) * 3))
        });
    });

    return nodes;
}

// Build links from edition data
function buildLinks(data, nodes) {
    const links = [];
    const nodeIds = new Set(nodes.map(n => n.id));

    // Create ownership links from artwork to current holders
    (data.collectors || []).forEach(collector => {
        if (collector.is_current_holder && nodeIds.has(collector.address)) {
            links.push({
                source: 'artwork',
                target: collector.address,
                type: 'ownership',
                distance: 80
            });
        }
    });

    // Create transfer links between collectors
    (data.transfers || []).forEach(transfer => {
        if (nodeIds.has(transfer.from) && nodeIds.has(transfer.to)) {
            links.push({
                source: transfer.from,
                target: transfer.to,
                type: 'transfer',
                distance: 120
            });
        }
    });

    return links;
}

// Drag behavior
function drag(simulation) {
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    return d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended);
}

// Highlight a collector in both list and visualization
function highlightCollector(address) {
    // Update list
    document.querySelectorAll('.collector-item').forEach(el => {
        el.classList.toggle('highlighted', el.dataset.address === address);
    });

    // Update visualization
    d3.selectAll('.collector-node circle')
        .attr('stroke-width', function(d) {
            return d.address === address ? 4 : 2;
        })
        .attr('filter', function(d) {
            return d.address === address ? 'drop-shadow(0 0 8px rgba(102, 178, 255, 0.8))' : 'none';
        });
}

// Control functions
function resetConstellation() {
    svg.transition()
        .duration(750)
        .call(d3.zoom().transform, d3.zoomIdentity);
}

function toggleLabels() {
    showLabels = !showLabels;
    g.selectAll('text').style('display', showLabels ? 'block' : 'none');
}

function animateFlow() {
    // Add flow animation to transfer lines
    g.selectAll('line')
        .filter(d => d.type === 'transfer')
        .classed('flow-line', true);

    setTimeout(() => {
        g.selectAll('line').classed('flow-line', false);
    }, 5000);
}

// Utility functions
function showError(containerId, message) {
    document.getElementById(containerId).innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">--</div>
            <div style="color: #ff6699;">${message}</div>
        </div>
    `;
}

function formatDate(timestamp) {
    if (!timestamp) return '--';
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Resize handler
window.addEventListener('resize', () => {
    if (editionData) {
        renderConstellation(editionData);
    }
});
</script>
{% endblock %}
